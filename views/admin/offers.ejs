<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Category Offers</title>
  <link href="https://fonts.googleapis.com/css2?family=Bellefair&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { font-family: 'Outfit', sans-serif; background:#f5f7fa; min-height:100vh; }
    .navbar{ background:white; padding:15px 30px; position:fixed; top:0; left:0; right:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.08) }
    .brand-name{ font-family:'Bellefair'; font-size:28px; color:#192430; text-decoration:none; }
    .sidebar{ width:250px; background:#f9f9f9; padding:20px 0; position:fixed; top:60px; bottom:0; left:0; overflow-y:auto }
    .sidebar a{ display:flex; align-items:center; padding:15px 30px; color:#192430; text-decoration:none; border-radius:15px }
    .sidebar a.active{ background:#3b6da1; color:white }
    .main-content{ margin-left:250px; padding:80px 30px 30px; }
    .category-table{ background:white; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.05) }
    .category-table th{ background:#3b6da1; color:white; }
    .category-description{ max-width:240px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a class="brand-name" href="/admin/offers">THE-END</a>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar d-none d-lg-block">
    <a href="/admin/dashboard"><i class="bi bi-grid"></i> Dashboard</a>
    <a href="/admin/categories"><i class="bi bi-tag"></i> Categories</a>
    <a href="/admin/offers" class="active"><i class="bi bi-gift"></i> Offers</a>
    <a href="/admin/products"><i class="bi bi-box"></i> Products</a>
    <a href="/admin/customers"><i class="bi bi-people"></i> Customers</a>
    <a href="/admin/orders"><i class="bi bi-cart"></i> Orders</a>
    <a href="/admin/coupons"><i class="bi bi-ticket"></i> Coupons</a>
    <a href="/admin/sales-report"><i class="bi bi-bar-chart"></i> Sales Report</a>
    <a href="/admin/wallet-management"><i class="bi bi-credit-card"></i>Wallet</a>
    <a href="/admin/logout"><i class="bi bi-box-arrow-right"></i> Sign Out</a>
  </div>

  <!-- Main -->
  <div class="main-content">
    <h2 class="mb-3">Category Offers</h2>

    <div class="category-table">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Category</th>
            <th>Description</th>
            <th>Offer Price</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (!cat || cat.length === 0) { %>
            <tr>
              <td colspan="5" class="text-center">No categories found.</td>
            </tr>
          <% } else { %>
            <% cat.forEach(category => { %>
              <tr data-id="<%= category._id %>">
                <td><%= category.name %></td>
                <td class="category-description"><%= category.description || '-' %></td>
                <td class="offer-price"><%= category.offerPrice ? '₹' + category.offerPrice : '0%' %></td>
                <td><%= category.visibility ? 'Active' : 'Inactive' %></td>
                <td class="text-center">
                  <button class="btn btn-sm <%= category.offerPrice ? 'btn-danger' : 'btn-success' %> toggle-offer"
                    data-id="<%= category._id %>"
                    data-price="<%= category.offerPrice || 0 %>">
                    <%= category.offerPrice ? 'Remove/Set Offer' : 'Add Offer' %>
                  </button>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener('click', async e => {
      const btn = e.target.closest('.toggle-offer');
      if (!btn) return;

      const id = btn.dataset.id;
      const currentPrice = Number(btn.dataset.price || 0);

      if (currentPrice > 0) {
        const confirm = await Swal.fire({
          title: 'Remove offer?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, remove'
        });
        if (!confirm.isConfirmed) return;
        await updateOffer(id, 0);
      } else {
        const { value: price } = await Swal.fire({
          title: 'Enter offer price (₹)',
          input: 'number',
          inputAttributes: { min: 1, step: 1 },
          showCancelButton: true
        });
        if (!price) return;
        await updateOffer(id, Number(price));
      }
    });

    async function updateOffer(categoryId, price) {
      try {
        const res = await fetch('/admin/category/offer/' + encodeURIComponent(categoryId), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ offerPrice: price })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        const row = document.querySelector(`tr[data-id="${categoryId}"]`);
        if (row) {
          const priceCell = row.querySelector('.offer-price');
          const btn = row.querySelector('.toggle-offer');

          if (price > 0) {
            priceCell.textContent = '₹' + price;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
            btn.dataset.price = price;
            btn.textContent = 'Remove/Set Offer';
          } else {
            priceCell.textContent = '0%';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-success');
            btn.dataset.price = 0;
            btn.textContent = 'Add Offer';
          }
        }

        Swal.fire('Success', data.message || 'Offer updated', 'success');
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'Could not update offer', 'error');
      }
    }
  </script>
</body>
</html>
