<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Bellefair&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/admindashboard.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="d-flex align-items-center">
            <button class="btn btn-link d-lg-none sidebar-toggle" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
                <i class="bi bi-list"></i>
            </button>
            <a href="/admin/dashboard" class="brand-name">COLINGUEST</a>
        </div>
        <div class="nav-right">
            <div class="d-flex align-items-center gap-2">
                <div id="customDateContainer" style="display: none;">
                    <input type="date" id="startDate" class="form-control form-control-sm" onchange="updateSalesReport()">
                    <span class="text-muted">to</span>
                    <input type="date" id="endDate" class="form-control form-control-sm" onchange="updateSalesReport()">
                </div>
                <select class="filter-select" id="periodFilter" onchange="handlePeriodChange()">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <button class="export-btn" onclick="exportData()">Export</button>
            <a href="/admin/logout" id="logoutBtn" class="btn">Logout</a>
        </div>
    </nav>

    <!-- Sidebar Offcanvas for Mobile -->
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="sidebarOffcanvas"
        aria-labelledby="sidebarOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="sidebar">
                <a href="/admin/dashboard"><i class="bi bi-grid"></i> Dashboard</a>
                <a href="/admin/categories"><i class="bi bi-tag"></i> Categories</a>
                <a href="/admin/brands"><i class="bi bi-badge-tm"></i> Brands</a>
                <a href="/admin/offers"><i class="bi bi-gift"></i> Offers</a>
                <a href="/admin/products"><i class="bi bi-box"></i> Products</a>
                <a href="/admin/customers"><i class="bi bi-people"></i> Customers</a>
                <a href="/admin/orders"><i class="bi bi-cart"></i> Orders</a>
                <a href="/admin/coupons"><i class="bi bi-ticket"></i> Coupons</a>
                <a href="/admin/sales-report" class="active"><i class="bi bi-bar-chart"></i> Sales Report</a>
                <a href="/admin/wallet-management"><i class="bi bi-credit-card"></i> Wallet</a>
                <a href="/admin/logout"><i class="bi bi-box-arrow-right"></i> Sign Out</a>
            </div>
        </div>
    </div>

    <!-- Desktop Sidebar -->
    <div class="sidebar d-none d-lg-block">
        <a href="/admin/dashboard"><i class="bi bi-grid"></i> Dashboard</a>
        <a href="/admin/categories"><i class="bi bi-tag"></i> Categories</a>
        <a href="/admin/brands"><i class="bi bi-badge-tm"></i> Brands</a>
        <a href="/admin/offers"><i class="bi bi-gift"></i> Offers</a>
        <a href="/admin/products"><i class="bi bi-box"></i> Products</a>
        <a href="/admin/coupons"><i class="bi bi-ticket"></i> Coupons</a>
        <a href="/admin/customers"><i class="bi bi-people"></i> Customers</a>
        <a href="/admin/orders"><i class="bi bi-cart"></i> Orders</a>
        <a href="/admin/sales-report" class="active"><i class="bi bi-bar-chart"></i> Sales Report</a>
        <a href="/admin/wallet-management"><i class="bi bi-credit-card"></i> Wallet</a>
        <a href="/admin/logout"><i class="bi bi-box-arrow-right"></i> Sign Out</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h2 class="dashboard-title">Sales Report</h2>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-xl-3">
                <div class="dashboard-card">
                    <div class="icon-container bg-primary text-white"><i class="bi bi-bag"></i></div>
                    <p class="text-muted mb-1">Total Orders</p>
                    <h5 id="totalOrders">Loading...</h5>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="dashboard-card">
                    <div class="icon-container bg-success text-white"><i class="bi bi-currency-rupee"></i></div>
                    <p class="text-muted mb-1">Total Amount</p>
                    <h5 id="totalAmount">Loading...</h5>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="dashboard-card">
                    <div class="icon-container bg-warning text-white"><i class="bi bi-percent"></i></div>
                    <p class="text-muted mb-1">Total Discounts</p>
                    <h5 id="totalDiscounts">Loading...</h5>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="dashboard-card">
                    <div class="icon-container bg-info text-white"><i class="bi bi-cash"></i></div>
                    <p class="text-muted mb-1">Net Sales</p>
                    <h5 id="netSales">Loading...</h5>
                </div>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5 class="mb-3">Recent Orders</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Payment Method</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Loading sales data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPeriod = 'today';

        // Initialize date inputs with today's date
        function initializeDates() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            document.getElementById('startDate').value = todayString;
            document.getElementById('endDate').value = todayString;
        }

        // Handle period change - show/hide custom dates
        function handlePeriodChange() {
            const period = document.getElementById('periodFilter').value;
            const customDateContainer = document.getElementById('customDateContainer');
            
            if (period === 'custom') {
                customDateContainer.style.display = 'flex';
                customDateContainer.style.alignItems = 'center';
                customDateContainer.style.gap = '8px';
            } else {
                customDateContainer.style.display = 'none';
            }
            
            updateSalesReport();
        }

        async function updateSalesReport() {
            const period = document.getElementById('periodFilter').value;
            currentPeriod = period;
            
            let url = `/admin/sales-data?period=${period}`;
            
            // If custom range is selected, add date parameters
            if (period === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                } else {
                    alert('Please select both start and end dates');
                    return;
                }
            }
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    updateStats(data.stats);
                    updateTable(data.recentOrders);
                } else {
                    console.error('Error loading sales data:', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateStats(stats) {
            document.getElementById('totalOrders').textContent = stats.totalOrders.toLocaleString();
            document.getElementById('totalAmount').textContent = `₹${stats.totalAmount.toLocaleString('en-IN')}`;
            document.getElementById('totalDiscounts').textContent = `₹${stats.totalDiscounts.toLocaleString('en-IN')}`;
            document.getElementById('netSales').textContent = `₹${stats.netSales.toLocaleString('en-IN')}`;
        }

        function updateTable(orders) {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No orders found for this period</td></tr>';
                return;
            }
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.orderId || order._id}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString('en-IN')}</td>
                    <td>${order.customerName || 'Guest'}</td>
                    <td>₹${order.totalAmount.toLocaleString('en-IN')}</td>
                    <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                    <td>${order.paymentMethod || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Delivered': return 'success';
                case 'Completed': return 'success';
                case 'Processing': return 'warning';
                case 'Pending': return 'warning';
                case 'Cancelled': return 'danger';
                default: return 'secondary';
            }
        }

        function exportData() {
            console.log('Export functionality to be implemented');
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            updateSalesReport();
        });
    </script>
</body>
</html>
