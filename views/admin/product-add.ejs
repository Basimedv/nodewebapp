<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Product - COLINGUEST</title>
  <link href="https://fonts.googleapis.com/css2?family=Bellefair&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Outfit', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    .navbar {
      background: white;
      padding: 15px 30px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .08)
    }
   
    .sidebar {
      width: 250px;
      background: #f9f9f9;
      padding: 20px 0;
      position: fixed;
      top: 60px;
      bottom: 0;
      left: 0;
      overflow-y: auto
    }
    .sidebar a {
      display: flex;
      align-items: center;
      padding: 15px 30px;
      color: #192430;
      text-decoration: none;
      border-radius: 15px
    }
    .sidebar a.active {
      background: #3b6da1;
      color: white
    }
    .sidebar a i {
      margin-right: 12px;
    }
    .main-content {
      margin-left: 250px;
      padding: 80px 30px 30px;
    }
    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .06);
    }
    .btn-primary {
      background: #0202a1;
      border-color: #1900ba;
    }
    .btn-primary:hover {
      background: #0b5ed7;
      border-color: #0b5ed7;
    }
    .error-message {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    .img-container {
      max-height: 70vh;
      overflow: hidden;
    }
    .img-container img {
      max-width: 100%;
      display: block;
    }
   
    /* Enhanced Image Upload Styling */
    .image-upload-slot {
      position: relative;
      min-height: 250px;
      border-radius: 8px;
      overflow: hidden;
    }

    .image-upload-dropzone {
      border: 2px dashed #d0d5dd;
      border-radius: 8px;
      min-height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f9fafb;
      padding: 20px;
    }

    .image-upload-dropzone:hover {
      border-color: #0d6efd;
      background: #f0f7ff;
      transform: translateY(-2px);
    }

    .image-upload-dropzone:hover i {
      color: #0d6efd !important;
      transform: scale(1.1);
    }

    .image-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      border: 2px solid #e5e7eb;
    }

    .image-preview .img-wrapper {
      position: relative;
      width: 100%;
      height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
    }

    .image-preview .img-fit {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .img-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 12px;
      font-size: 0.7rem;
      border-radius: 4px;
      font-weight: 600;
      color: white;
      z-index: 10;
    }

    .badge-success { background: #10b981; }
    .badge-info { background: #3b82f6; }

    .remove-image-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
    }

    .remove-image-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .recrop-image-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      z-index: 10;
      transition: all 0.2s;
    }

    .recrop-image-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .form-control:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    .form-control.is-invalid,
    .form-select.is-invalid {
      border-color: #dc3545;
    }

    @media (max-width: 768px) {
      .image-upload-slot {
        min-height: 200px;
      }
      
      .image-upload-dropzone {
        min-height: 200px;
      }
      
      .image-preview .img-wrapper {
        height: 200px;
      }
    }
    
    .aspect-ratio-btn.active {
      background-color: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    .brand-name {
      font-family: 'Bellefair';
      font-size: 28px;
      color: #192430;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a class="brand-name" href="/admin/products">COLINGUEST</a>
  </nav>

  <div class="sidebar d-none d-lg-block">
    <a href="/admin/dashboard"><i class="bi bi-grid"></i> Dashboard</a>
    <a href="/admin/categories"><i class="bi bi-tag"></i> Categories</a>
    <a href="/admin/products" class="active"><i class="bi bi-box"></i> Products</a>
    <a href="/admin/customers"><i class="bi bi-people"></i> Customers</a>
    <a href="/admin/orders"><i class="bi bi-cart"></i> Orders</a>
    <a href="/admin/coupons"><i class="bi bi-ticket"></i> Coupons</a>
    <a href="/admin/sales-report"><i class="bi bi-bar-chart"></i> Sales Report</a>
    <a href="/admin/wallet-management"><i class="bi bi-credit-card"></i> Wallet</a>
    <a href="/admin/logout"><i class="bi bi-box-arrow-right"></i> Sign Out</a>
  </div>

  <div class="main-content">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h2 class="mb-1" style="color:#1a1b1c;">Add New Product</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/admin/products">Products</a></li>
            <li class="breadcrumb-item active">Add Product</li>
          </ol>
        </nav>
      </div>
      <a href="/admin/products" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
      </a>
    </div>

    <div class="card">
      <div class="card-body p-4">
        <form id="addProductForm" enctype="multipart/form-data">
          <!-- Single Column Layout -->
          <div class="row">
            <div class="col-12">
              
              <!-- Product Name -->
              <div class="mb-3">
                <label class="form-label" for="productName">Product Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="productName" name="productName" 
                       placeholder="Enter product name" required>
                <div id="productName-error" class="error-message"></div>
              </div>

              <!-- Category -->
              <div class="mb-3">
                <label class="form-label" for="category">Category <span class="text-danger">*</span></label>
                <select id="category" name="category" class="form-select" required>
                  <option value="">Select Category</option>
                  <% for(let i=0; i < cat.length; i++) { %>
                    <option value="<%= cat[i]._id %>"><%= cat[i].name %></option>
                  <% } %>
                </select>
                <div id="category-error" class="error-message"></div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4" 
                          placeholder="Write your description here..."></textarea>
                <div id="description-error" class="error-message"></div>
              </div>

              <!-- Price Row -->
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label class="form-label" for="regularPrice">Base Price (‚Çπ) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="regularPrice" name="regularPrice" 
                         placeholder="0.00" min="0" step="0.01" required>
                  <div id="regularPrice-error" class="error-message"></div>
                </div>

              </div>

              <!-- Stock by Size Section -->
              <div class="mb-3">
                <label class="form-label">Stock by Size <span class="text-danger">*</span></label>
                <div class="row">
                  <% ['S', 'M', 'L', 'XL', 'XXL'].forEach(size => { %>
                    <div class="col-md-2 mb-2">
                      <label><%= size %></label>
                      <input type="number" 
                             name="stock_<%= size %>" 
                             id="stock_<%= size %>" 
                             class="form-control" 
                             min="0" 
                             value="0">
                    </div>
                  <% }) %>
                </div>
              </div>

              <div class="alert alert-info mt-3 mb-0">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Total Stock:</strong> <span id="totalStock" class="fs-5 fw-bold">0</span> units
              </div>
              <div id="stock-error" class="error-message"></div>

              <!-- Hidden input for size array -->
              <input type="hidden" id="size-array" name="size">

              <!-- Status -->
              <div class="mb-4">
                <label class="form-label" for="status">Status</label>
                <select id="status" name="status" class="form-select">
                  <option value="Available" selected>Available</option>
                  <option value="Out of Stock">Out of Stock</option>
                  <option value="Discontinued">Discontinued</option>
                </select>
              </div>

              <!-- Product Images Section -->
              <div class="mb-4">
                <label class="form-label fw-bold">Product Images <span class="text-danger">*</span></label>
                <p class="text-muted small">Upload & crop up to 3 images (Recommended: Square images, 800x800px)</p>
                
                <div class="row g-3">
                  <% for (let i = 0; i < 3; i++) { %>
                    <div class="col-md-4">
                      <div class="image-upload-slot" data-slot="<%= i %>">
                        <!-- Dropzone -->
                        <div class="image-upload-dropzone">
                          <i class="bi bi-cloud-upload" style="font-size: 2.5rem; color: #bbb;"></i>
                          <p class="mb-0 mt-2 small">Add Image</p>
                        </div>

                        <!-- Preview (initially hidden) -->
                        <div class="image-preview d-none"></div>
                      </div>
                    </div>
                  <% } %>
                </div>

                <div id="imageError" class="text-danger mt-2 small"></div>
              </div>

              <!-- Form Actions -->
              <hr class="my-4">
              <div class="d-flex justify-content-between align-items-center">
                <a href="/admin/products" class="btn btn-outline-secondary">
                  <i class="bi bi-x-circle me-1"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary btn-lg px-5">
                  <i class="bi bi-plus-circle me-2"></i> Add Product
                </button>
              </div>

            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Crop Modal -->
  <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title fw-bold" id="cropModalLabel">
            <i class="bi bi-crop me-2"></i>Crop Your Image
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <div class="row">
            <div class="col-md-9">
              <div class="img-container rounded overflow-hidden bg-light mb-3" style="max-height: 500px;">
                <img id="imageToCrop" src="" alt="Image to crop" class="img-fluid" style="max-height: 500px; object-fit: contain;">
              </div>
              
              <div class="d-flex flex-wrap gap-2 justify-content-center">
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateLeft" title="Rotate Left">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateRight" title="Rotate Right">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
                
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="flipH" title="Flip Horizontal">
                    <i class="bi bi-arrow-left-right"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="flipV" title="Flip Vertical">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </div>
                
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="zoomIn" title="Zoom In">
                    <i class="bi bi-zoom-in"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="zoomOut" title="Zoom Out">
                    <i class="bi bi-zoom-out"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="resetZoom" title="Reset">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="mb-3">
                <h6 class="fw-bold mb-2">Preview</h6>
                <div id="cropPreview" class="border rounded" style="width: 100%; height: 200px; overflow: hidden; background: #f8f9fa;"></div>
              </div>
              
              <div class="mb-3">
                <h6 class="fw-bold mb-2">Aspect Ratio</h6>
                <div class="btn-group-vertical w-100" role="group">
                  <button type="button" class="btn btn-sm btn-outline-primary active aspect-ratio-btn" data-ratio="1">
                    Square (1:1)
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-primary aspect-ratio-btn" data-ratio="1.333">
                    Landscape (4:3)
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-primary aspect-ratio-btn" data-ratio="0">
                    Free
                  </button>
                </div>
              </div>
              
              <div class="alert alert-info small mb-0">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Tip:</strong> Use mouse wheel to zoom, drag to move the image.
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 justify-content-between">
          <button type="button" class="btn btn-outline-secondary px-4 py-2" data-bs-dismiss="modal">
            <i class="bi bi-x me-1"></i>Cancel
          </button>
          <div>
            <button type="button" class="btn btn-secondary px-4 py-2 me-2" id="skipCropButton">
              <i class="bi bi-skip-forward me-1"></i>Skip Crop
            </button>
            <button type="button" class="btn btn-primary px-4 py-2 fw-semibold" id="cropButton">
              <i class="bi bi-crop me-1"></i>Crop & Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Stock management functions
    function updateTotal() {
      const sizes = ['S', 'M', 'L', 'XL', 'XXL'];
      let total = 0;
      const availableSizes = [];
      
      sizes.forEach(size => {
        const input = document.getElementById(`stock_${size}`);
        if (!input) return;
        
        const stockValue = parseInt(input.value) || 0;
        
        if (stockValue > 0) {
          total += stockValue;
          availableSizes.push(size);
        }
      });
      
      const totalStockEl = document.getElementById('totalStock');
      const sizeArrayEl = document.getElementById('size-array');
      const stockErrorEl = document.getElementById('stock-error');
      
      if (totalStockEl) {
        totalStockEl.textContent = total;
      }
      
      if (sizeArrayEl) {
        sizeArrayEl.value = JSON.stringify(availableSizes);
      }
      
      if (stockErrorEl) {
        if (total === 0) {
          stockErrorEl.textContent = 'Please add stock for at least one size';
          stockErrorEl.style.display = 'block';
        } else {
          stockErrorEl.style.display = 'none';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      let cropper = null;
      let currentFile = null;
      let currentSlotNumber = null;
      let selectedFiles = {};
      let scaleX = 1;
      let scaleY = 1;
      
      // Initialize total stock calculation
      updateTotal();
      
      // Add change listeners to all stock inputs
      const sizes = ['S', 'M', 'L', 'XL', 'XXL'];
      sizes.forEach(size => {
        const input = document.getElementById(`stock_${size}`);
        if (input) {
          input.addEventListener('change', updateTotal);
          input.addEventListener('input', updateTotal);
        }
      });

      // ========================================================
      // IMAGE UPLOAD AND CROPPING
      // ========================================================

      console.log('üîß Initializing image upload slots...');
      
      const imageSlots = document.querySelectorAll('.image-upload-slot');
      console.log('üì¶ Found', imageSlots.length, 'image slots');
      
      imageSlots.forEach((slot, index) => {
        console.log(`Setting up slot ${index}...`);
        setupImageSlot(slot);
      });

      function setupImageSlot(slot) {
        const slotNumber = slot.dataset.slot;
        const dropzone = slot.querySelector('.image-upload-dropzone');
        const preview = slot.querySelector('.image-preview');

        console.log(`üì∏ Setting up slot #${slotNumber}`);

        // Create hidden file input
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/jpeg,image/jpg,image/png,image/webp';
        input.style.display = 'none';
        input.setAttribute('data-slot', slotNumber);
        slot.appendChild(input);

        console.log(`‚úÖ File input created for slot #${slotNumber}`);

        // Click event on dropzone
        dropzone.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log(`üñ±Ô∏è Dropzone clicked for slot #${slotNumber}`);
          input.click();
        });

        // Handle file selection
        input.addEventListener('change', (e) => {
          console.log(`üìÅ File selected for slot #${slotNumber}`);
          const file = e.target.files[0];
          
          if (file) {
            console.log(`‚úÖ File details:`, {
              name: file.name,
              size: (file.size / 1024).toFixed(2) + ' KB',
              type: file.type
            });

            if (file.type.startsWith('image/')) {
              currentFile = file;
              currentSlotNumber = slotNumber;
              openCropModal(file, slotNumber);
            } else {
              alert('Please select a valid image file (JPG, PNG, or WebP)');
            }
          }
        });

        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.style.borderColor = '#0d6efd';
          dropzone.style.background = '#e7f1ff';
        });

        dropzone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.style.borderColor = '#d0d5dd';
          dropzone.style.background = '#f9fafb';
        });

        dropzone.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.style.borderColor = '#d0d5dd';
          dropzone.style.background = '#f9fafb';
          
          console.log(`üìÇ File dropped on slot #${slotNumber}`);
          
          const file = e.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')) {
            console.log(`‚úÖ Valid image dropped:`, file.name);
            currentFile = file;
            currentSlotNumber = slotNumber;
            
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            input.files = dataTransfer.files;
            
            openCropModal(file, slotNumber);
          } else {
            alert('Please drop a valid image file (JPG, PNG, or WebP)');
          }
        });
      }

      function openCropModal(file, slotNumber) {
        console.log(`üñºÔ∏è Opening crop modal for slot #${slotNumber}`);
        
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.getElementById('imageToCrop');
          img.src = e.target.result;
          img.dataset.slotNumber = slotNumber;
          img.dataset.fileName = file.name;

          const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
          cropModal.show();

          document.getElementById('cropModal').addEventListener('shown.bs.modal', () => {
            initializeCropper();
          }, { once: true });
        };
        reader.readAsDataURL(file);
      }

      function initializeCropper() {
        console.log('‚úÇÔ∏è Initializing cropper...');
        const image = document.getElementById('imageToCrop');
        if (cropper) cropper.destroy();
        scaleX = 1;
        scaleY = 1;
        cropper = new Cropper(image, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          responsive: true,
          background: false,
          zoomable: true,
          scalable: true,
          rotatable: true,
          cropBoxResizable: true,
          cropBoxMovable: true,
          dragMode: 'move',
          preview: '#cropPreview',
        });
        console.log('‚úÖ Cropper initialized');
      }

      // Cropper controls
      document.getElementById('rotateLeft').addEventListener('click', () => { 
        if (cropper) cropper.rotate(-45); 
      });
      
      document.getElementById('rotateRight').addEventListener('click', () => { 
        if (cropper) cropper.rotate(45); 
      });
      
      document.getElementById('flipH').addEventListener('click', () => { 
        scaleX = -scaleX; 
        if (cropper) cropper.scaleX(scaleX); 
      });
      
      document.getElementById('flipV').addEventListener('click', () => { 
        scaleY = -scaleY; 
        if (cropper) cropper.scaleY(scaleY); 
      });
      
      document.getElementById('zoomIn').addEventListener('click', () => { 
        if (cropper) cropper.zoom(0.1); 
      });
      
      document.getElementById('zoomOut').addEventListener('click', () => { 
        if (cropper) cropper.zoom(-0.1); 
      });
      
      document.getElementById('resetZoom').addEventListener('click', () => { 
        if (cropper) cropper.reset(); 
      });

      // Aspect ratio buttons
      document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.aspect-ratio-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const ratio = parseFloat(this.dataset.ratio);
          if (cropper) cropper.setAspectRatio(ratio === 0 ? NaN : ratio);
        });
      });

      // Crop button
      document.getElementById('cropButton').addEventListener('click', () => {
        if (!cropper) return;
        
        console.log('‚úÇÔ∏è Cropping image...');
        
        const canvas = cropper.getCroppedCanvas({ 
          width: 800, 
          height: 800, 
          imageSmoothingQuality: 'high' 
        });
        
        canvas.toBlob(blob => {
          const image = document.getElementById('imageToCrop');
          const slotNumber = image.dataset.slotNumber;
          const fileName = image.dataset.fileName;
          const croppedFile = new File([blob], fileName, { 
            type: 'image/jpeg', 
            lastModified: Date.now() 
          });
          
          console.log(`‚úÖ Image cropped for slot #${slotNumber}`);
          
          selectedFiles[slotNumber] = croppedFile;
          updatePreview(slotNumber, URL.createObjectURL(croppedFile), true);
          bootstrap.Modal.getInstance(document.getElementById('cropModal')).hide();
          
          document.getElementById('imageError').textContent = '';
        }, 'image/jpeg', 0.95);
      });

      // Skip crop button
      document.getElementById('skipCropButton').addEventListener('click', () => {
        const image = document.getElementById('imageToCrop');
        const slotNumber = image.dataset.slotNumber;
        
        console.log(`‚è≠Ô∏è Skipping crop for slot #${slotNumber}`);
        
        selectedFiles[slotNumber] = currentFile;
        const reader = new FileReader();
        reader.onload = e => updatePreview(slotNumber, e.target.result, false);
        reader.readAsDataURL(currentFile);
        bootstrap.Modal.getInstance(document.getElementById('cropModal')).hide();
        
        document.getElementById('imageError').textContent = '';
      });

      function updatePreview(slotNumber, url, isCropped = false) {
        console.log(`üñºÔ∏è Updating preview for slot #${slotNumber}`);
        
        const slot = document.querySelector(`.image-upload-slot[data-slot="${slotNumber}"]`);
        const dropzone = slot.querySelector('.image-upload-dropzone');
        const preview = slot.querySelector('.image-preview');

        dropzone.classList.add('d-none');
        preview.classList.remove('d-none');

        preview.innerHTML = `
          <div class="img-wrapper">
            <img src="${url}" alt="Preview" class="img-fit">
            <span class="img-badge ${isCropped ? 'badge-success' : 'badge-info'}">
              ${isCropped ? '‚úì Cropped' : 'Original'}
            </span>
            <button type="button" class="remove-image-btn" data-slot="${slotNumber}">√ó</button>
            <button type="button" class="recrop-image-btn" data-slot="${slotNumber}">Re-crop</button>
          </div>
        `;

        preview.querySelector('.remove-image-btn').addEventListener('click', () => {
          removeImage(slotNumber);
        });

        preview.querySelector('.recrop-image-btn').addEventListener('click', () => {
          const file = selectedFiles[slotNumber];
          if (!file) return;
          currentFile = file;
          currentSlotNumber = slotNumber;
          openCropModal(file, slotNumber);
        });
        
        console.log(`‚úÖ Preview updated for slot #${slotNumber}`);
      }

      function removeImage(slotNumber) {
        console.log(`üóëÔ∏è Removing image from slot #${slotNumber}`);
        
        const slot = document.querySelector(`.image-upload-slot[data-slot="${slotNumber}"]`);
        const dropzone = slot.querySelector('.image-upload-dropzone');
        const preview = slot.querySelector('.image-preview');

        delete selectedFiles[slotNumber];

        preview.classList.add('d-none');
        preview.innerHTML = '';
        dropzone.classList.remove('d-none');
        
        const input = slot.querySelector('input[type="file"]');
        if (input) {
          input.value = '';
        }
        
        console.log(`‚úÖ Image removed from slot #${slotNumber}`);
      }

      // ========================================================
      // FORM SUBMISSION
      // ========================================================
      
      document.getElementById('addProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        console.log('====================================');
        console.log('üì§ SUBMITTING PRODUCT FORM');
        console.log('====================================');

        // Validate stock
        const sizeArray = JSON.parse(document.getElementById('size-array').value || '[]');
        if (sizeArray.length === 0) {
          Swal.fire({
            icon: 'error',
            title: 'No Stock',
            text: 'Please add stock for at least one size',
            confirmButtonColor: '#0202a1'
          });
          return;
        }

        // Validate images
        const totalImages = Object.keys(selectedFiles).length;
        console.log(`üì∏ Total images selected: ${totalImages}`);
        
        if (totalImages === 0) {
          document.getElementById('imageError').textContent = 'Please upload at least one product image';
          Swal.fire({
            icon: 'error',
            title: 'No Images',
            text: 'Please upload at least one product image',
            confirmButtonColor: '#0202a1'
          });
          return;
        }

        const formData = new FormData();

        // Add all form fields
        formData.append('productName', document.getElementById('productName').value.trim());
        formData.append('description', document.getElementById('description').value.trim());
        formData.append('category', document.getElementById('category').value);
        formData.append('regularPrice', document.getElementById('regularPrice').value);
        formData.append('status', document.getElementById('status').value);

        // Add stock data for each size
        formData.append('stock_S', document.getElementById('stock_S').value);
        formData.append('stock_M', document.getElementById('stock_M').value);
        formData.append('stock_L', document.getElementById('stock_L').value);
        formData.append('stock_XL', document.getElementById('stock_XL').value);
        formData.append('stock_XXL', document.getElementById('stock_XXL').value);
        
        // Add size array
        formData.append('size', document.getElementById('size-array').value);

        // Add images to FormData
        console.log('üìé Adding images to FormData...');
        for (const [slot, file] of Object.entries(selectedFiles)) {
          console.log(`  Adding image from slot ${slot}:`, file.name);
          formData.append('images', file);
        }

        // Debug: Log FormData contents
        console.log('üìã FormData contents:');
        for (let [key, value] of formData.entries()) {
          if (value instanceof File) {
            console.log(`  ${key}:`, value.name, `(${(value.size / 1024).toFixed(2)} KB)`);
          } else {
            console.log(`  ${key}:`, value);
          }
        }

        try {
          console.log('üöÄ Sending request to /admin/products...');
          
          const response = await fetch('/admin/products', {
            method: 'POST',
            body: formData
          });

          console.log('üì® Response received:', response.status);

          const result = await response.json();
          console.log('üì¶ Response data:', result);

          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Product added successfully',
              confirmButtonColor: '#0202a1'
            }).then(() => {
              window.location.href = '/admin/products';
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: result.message || 'Failed to add product',
              confirmButtonColor: '#0202a1'
            });
          }
        } catch (error) {
          console.error('‚ùå Error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while adding the product',
            confirmButtonColor: '#0202a1'
          });
        }
      });

      // ========================================================
      // FORM VALIDATION
      // ========================================================
      
      function showError(fieldId, message) {
        const errorDiv = document.getElementById(`${fieldId}-error`);
        const inputField = document.getElementById(fieldId);
        
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
        }
        
        if (inputField) {
          inputField.classList.add('is-invalid');
        }
      }

      function clearError(fieldId) {
        const errorDiv = document.getElementById(`${fieldId}-error`);
        const inputField = document.getElementById(fieldId);
        
        if (errorDiv) {
          errorDiv.textContent = '';
          errorDiv.style.display = 'none';
        }
        
        if (inputField) {
          inputField.classList.remove('is-invalid');
        }
      }

      // Real-time validation
      document.getElementById('productName').addEventListener('input', function() {
        const value = this.value.trim();
        
        if (!value) {
          showError('productName', 'Product name is required');
          return;
        }
        
        if (value.length < 3) {
          showError('productName', 'Product name must be at least 3 characters');
          return;
        }
        
        if (value.length > 100) {
          showError('productName', 'Product name must not exceed 100 characters');
          return;
        }
        
        clearError('productName');
      });

      document.getElementById('category').addEventListener('change', function() {
        if (this.value) clearError('category');
      });

      document.getElementById('regularPrice').addEventListener('input', function() {
        const value = parseFloat(this.value);
        if (value > 0) clearError('regularPrice');
      });


      console.log('‚úÖ Product add page script loaded');
    });
  </script>
</body>
</html>