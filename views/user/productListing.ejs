<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COLINGUEST</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            margin: 0;
        }

        main {
            min-height: calc(100vh - 80px);
            padding-bottom: 2rem;
        }

        .signup-btn,
        .icon-btn {
            background: #2a2931;
            color: white;
            border: none;
            padding: 0 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            font-size: 15px;
            text-decoration: none;
        }

        /* HORIZONTAL FILTER BAR */
        .horizontal-filter-bar {
            background: #f8f9fa;
            padding: 20px 30px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filter-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            margin: 0;
            white-space: nowrap;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
            background: white;
            min-width: 150px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: #333;
        }

        .price-range-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-range-group input {
            width: 100px;
        }

        .price-range-group span {
            color: #666;
            font-size: 14px;
        }

        .apply-btn {
            background: #333;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
            height: 38px;
        }

        .apply-btn:hover {
            background: #000;
        }

        .search-right {
            float: right;
            margin-top: -28px;
            margin-right: 10px;
        }

        .searchBar {
            width: 250px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            background: transparent;
            border-radius: 6px;
            outline: none;
            float: right;
            margin-top: -8px;
            margin-right: 10px;
            backdrop-filter: blur(4px);
            color: #000;
        }

        .searchBar:focus {
            border-color: #000;
        }

        /* ==========================================
           EXACT PRODUCT CARD MATCH FROM REFERENCE
           ========================================== */

        .product-card {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            margin-bottom: 2rem;
            position: relative;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            height: 90%;
            overflow: visible;
        }

        .product-card:hover {
            transform: translateY(-4px);
        }

        .image-container {
            position: relative;
            width: 90%;
            padding-bottom: 133.33%;
            /* 3:4 aspect ratio */
            overflow: hidden;
            background: #f5f5f5;
            margin-bottom: 1rem;
        }

        .product-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease-in-out;
        }

        .main-img {
            opacity: 1;
            z-index: 1;
        }

        .hover-img {
            opacity: 0;
            z-index: 2;
        }

        .image-container:hover .main-img {
            opacity: 0;
        }

        .image-container:hover .hover-img {
            opacity: 1;
        }

        .wishlist-icon {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1rem;
            color: #000;
            cursor: pointer;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 4px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
        }

        .image-container:hover .wishlist-icon {
            opacity: 1;
        }

        .wishlist-icon:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .wishlist-icon.active {
            color: #ff6b6b;
        }

        .wishlist-icon.active i {
            font-weight: 900;
        }

        .card-body {
            padding: 0 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .product-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .product-link:hover {
            text-decoration: none;
            color: inherit;
        }

        .productname {
            font-size: 19px;
            color: #000;
            letter-spacing: 0;
            line-height: 1.4;
            font-weight: 400;
            margin-bottom: 6px;
            min-height: 40px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .rating-stars {
            color: #ffa500;
            font-size: 0.75rem;
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .price-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .price {
            color: #000000;
            font-weight: 600;
            font-size: 1rem;
            margin: 0;
        }

        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.85rem;
            font-weight: 400;
        }

        .discount-badge {
            color: #ff6b6b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* BUTTON STYLING - EXACT MATCH */
        .btn-select-options {
            background-color: #a8977c;
            color: #fff;
            width: 50%;
            padding: 10px;
            font-size: 13px;
            border: none;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            text-transform: capitalize;
            margin-left: 75px;
        }

        .btn-select-options:hover:not(:disabled) {
            background-color: #968869;
        }

        .btn-select-options:disabled {
            background-color: #ccc;
            opacity: 0.6;
        }

        .btn-add-wishlist {
            background-color: transparent;
            color: #000;
            width: 100%;
            padding: 10px;
            font-size: 13px;
            border: 1px solid #000;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-add-wishlist:hover {
            background-color: #000;
            color: #fff;
        }

        .btn-add-wishlist i {
            font-size: 14px;
        }

        /* RESPONSIVE GRID */
        .row.g-4 {
            --bs-gutter-x: 1.5rem;
            --bs-gutter-y: 2rem;
        }

        @media (max-width: 768px) {
            .image-container {
                padding-bottom: 140%;
            }

            .productname {
                font-size: 13px;
                min-height: 36px;
            }

            .price {
                font-size: 0.9rem;
            }

            .product-card {
                margin-bottom: 1.5rem;
            }
        }

        @media (max-width: 576px) {
            .row.g-4 {
                --bs-gutter-x: 1rem;
                --bs-gutter-y: 1.5rem;
            }
        }

        /* PAGINATION STYLES */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 3rem;
            padding: 0;
            list-style: none;
        }

        .pagination .page-item {
            display: inline-block;
        }

        .pagination .page-link {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pagination .page-link:hover {
            background: #333;
            color: white;
            border-color: #333;
        }

        .pagination .page-item.active .page-link {
            background: #333;
            color: white;
            border-color: #333;
        }

        /* STOCK STATUS - Enhanced visibility */
        .stock-status {
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stock-in {
            background: transparent;
            color: #10b136;
            border: 1px solid #c3e6cb;
        }

        .stock-low {
            background: transparent;
            color: #856404;
        }

        .stock-out {
            background: transparent;
            color: #721c24;
        }

        /* OUT OF STOCK BADGE */
        .out-of-stock-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 5;
            border-radius: 4px;
        }

        .image-container.out-of-stock {
            opacity: 0.6;
        }

        .image-container.out-of-stock .product-img {
            filter: grayscale(100%);
        }
        .clear-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
    font-size: 14px;
    height: 38px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.clear-btn:hover {
    background: #c82333;
}

.clear-btn i {
    font-size: 12px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
    }
    
    .filter-group input,
    .filter-group select {
        width: 100%;
    }
    
    .price-range-group {
        flex-direction: row;
    }
    
    .filter-group[style*="gap: 10px"] {
        flex-direction: row;
    }
    
    .apply-btn,
    .clear-btn {
        flex: 1;
    }
}
    </style>
</head>

<body data-user-id="<%= user ? user._id : '' %>">

   <%- include("../partials/user/header") %>

    <div class="search-right">
        <form id="searchProductForm" action="/shop" method="get" style="display:flex; align-items:center; gap:8px;">
            <input type="hidden" name="category"
                value="<%= appliedFilters && appliedFilters.category ? appliedFilters.category : '' %>">
            <input type="hidden" name="price"
                value="<%= appliedFilters && appliedFilters.price ? appliedFilters.price : '' %>">
            <input type="hidden" name="availability"
                value="<%= appliedFilters && appliedFilters.availability ? appliedFilters.availability : '' %>">
            <input type="hidden" name="sort"
                value="<%= appliedFilters && appliedFilters.sort ? appliedFilters.sort : 'newest' %>">
            <input type="text" class="searchBar" name="result" placeholder="Search product..."
                value="<%= appliedFilters && appliedFilters.result ? appliedFilters.result : '' %>">
            <button class="icon-btn" type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
        </form>
    </div>

    <div class="container-fluid px-4">
        <!-- HORIZONTAL FILTER BAR -->
        <div class="horizontal-filter-bar">
            <form id="filterForm" action="/shop" method="get">
                <input type="hidden" name="result"
                    value="<%= appliedFilters && appliedFilters.result ? appliedFilters.result : '' %>">

                <div class="filter-container">
                    <!-- Price Range -->
                    <div class="filter-group price-range-group">
                        <label>Price Range:</label>
                        <input type="number" name="minPrice" placeholder="Min"
                            value="<%= appliedFilters && appliedFilters.minPrice ? appliedFilters.minPrice : '' %>">
                        <span>to</span>
                        <input type="number" name="maxPrice" placeholder="Max"
                            value="<%= appliedFilters && appliedFilters.maxPrice ? appliedFilters.maxPrice : '' %>">
                    </div>

                    <!-- Category -->
                    <div class="filter-group">
                        <label>Category:</label>
                        <select name="category">
                            <option value="">All Categories</option>
                            <% category.forEach(cat=> { %>
                                <option value="<%= cat.name %>" <%=appliedFilters && appliedFilters.category &&
                                    appliedFilters.category.includes(cat.name) ? 'selected' : '' %>>
                                    <%= cat.name %>
                                </option>
                                <% }) %>
                        </select>
                    </div>

                    <!-- Sort By -->
                    <div class="filter-group">
                        <label>Sort by:</label>
                        <select name="sort">
                            <option value="newest" <%=sortOption==='newest' ? 'selected' : '' %>>Newest</option>
                            <option value="priceLowToHigh" <%=sortOption==='priceLowToHigh' ? 'selected' : '' %>>Price:
                                Low to High</option>
                            <option value="priceHighToLow" <%=sortOption==='priceHighToLow' ? 'selected' : '' %>>Price:
                                High to Low</option>
                            <option value="aToZ" <%=sortOption==='aToZ' ? 'selected' : '' %>>A to Z</option>
                            <option value="zToA" <%=sortOption==='zToA' ? 'selected' : '' %>>Z to A</option>
                            <option value="ratingHighToLow" <%=sortOption==='ratingHighToLow' ? 'selected' : '' %>
                                >Rating: High to Low</option>
                        </select>
                    </div>

                     <div class="filter-group" style="gap: 10px;">
                <button type="submit" class="apply-btn">Apply Filters</button>
                <button type="button" class="clear-btn" id="clearFilters">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
                </div>
            </form>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4 justify-content-start mt-4">
                    <% products.forEach(product=> { 
                        // Calculate all variables at the start
                        const regular = Number(product.regularPrice || 0); 
                        const productOffer = Number(product.productOffer || 0);
                        const categoryOffer = Number(product.category?.categoryOffer || 0);
                        
                        // Display the greater offer
                        let appliedOffer = 0;
                        let appliedOfferType = '';
                        
                        if (productOffer > categoryOffer) {
                            appliedOffer = productOffer;
                            appliedOfferType = 'product';
                        } else if (categoryOffer > productOffer) {
                            appliedOffer = categoryOffer;
                            appliedOfferType = 'category';
                        }
                        
                        const offerPrice = appliedOffer > 0 ? Math.round(regular - (regular * appliedOffer / 100)) : regular;
                        const finalPrice = appliedOffer > 0 ? offerPrice : regular;
                        const totalStock = product.stock ? 
                            (product.stock.S || 0) + (product.stock.M || 0) + (product.stock.L || 0) + 
                            (product.stock.XL || 0) + (product.stock.XXL || 0) : 0;
                    %>
                        <div class="col">
                            <div class="card product-card">
                                <a href="/productDetails/<%= product._id %>" class="product-link">
                                    <div class="image-container <%= totalStock === 0 ? 'out-of-stock' : '' %>">
                                        <img class="product-img main-img" src="<%= product.images[0] %>"
                                            alt="<%= product.name %>">
                                        <% if(product.images[1]) { %>
                                            <img class="product-img hover-img" src="<%= product.images[1] %>"
                                                alt="<%= product.name %>">
                                        <% } %>

                                        <% if (totalStock === 0) { %>
                                            <div class="out-of-stock-badge">OUT OF STOCK</div>
                                        <% } else { %>
                                            <div class="wishlist-icon" data-product-id="<%= product._id %>">
                                                <i class="fa-heart far"></i>
                                                <span>Add to wishlist</span>
                                            </div>
                                        <% } %>
                                    </div>
                                </a>

                                <div class="card-body">
                                    <h5 class="productname">
                                        <%= product.name %>
                                    </h5>
                                    <div class="price-section">
                                        <div class="price">
                                            ₹<%= finalPrice.toLocaleString('en-IN') %>
                                        </div>
                                        <% if (finalPrice < regular) { %>
                                            <span class="original-price">₹<%= regular.toLocaleString('en-IN') %>
                                            </span>
                                        <% } %>
                                    </div>
                                    
                                    <!-- Offer Badges -->
                                    <div class="offer-badges mb-2">
                                        <% if (appliedOffer > 0) { %>
                                            <span class="badge bg-success"><%= appliedOffer %>% OFF</span>
                                        <% } %>
                                    </div>

                                    <!-- STOCK STATUS -->
                                    <% if (totalStock===0) { %>
                                        <div class="stock-status stock-out">
                                            Out of Stock
                                        </div>
                                    <% } else if (totalStock < 10) { %>
                                        <div class="stock-status stock-low">
                                            Only <%= totalStock %> left!
                                        </div>
                                    <% } else { %>
                                        <div class="stock-status stock-in">
                                            In Stock
                                        </div>
                                    <% } %>

                                    <button data-product-id="<%= product._id %>"
                                        data-price="<%= finalPrice %>"
                                        class="btn-select-options" <%=totalStock===0 ? 'disabled' : '' %>>
                                        <%= totalStock===0 ? 'Out of Stock' : 'Select options' %>
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>

                <!-- PAGINATION -->
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <% const queryParams=new URLSearchParams(); 
                        if (appliedFilters?.category) { 
                            const categories=Array.isArray(appliedFilters.category) ? appliedFilters.category : [appliedFilters.category]; 
                            categories.forEach(cat=> queryParams.append('category', cat));
                        }
                        if (appliedFilters?.minPrice) queryParams.set('minPrice', appliedFilters.minPrice);
                        if (appliedFilters?.maxPrice) queryParams.set('maxPrice', appliedFilters.maxPrice);
                        if (appliedFilters?.availability) queryParams.set('availability', 'outOfStock');
                        if (appliedFilters?.result) queryParams.set('result', appliedFilters.result);
                        if (appliedFilters?.sort) queryParams.set('sort', appliedFilters.sort);
                        %>
                        <% if (currentPage> 1) { %>
                            <li class="page-item"><a class="page-link"
                                    href="?<%= queryParams.toString() %>&page=<%= currentPage - 1 %>">Previous</a>
                            </li>
                        <% } %>
                        <% for (let i=1; i <=totalPages; i++) { %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?<%= queryParams.toString() %>&page=<%= i %>">
                                    <%= i %>
                                </a>
                            </li>
                        <% } %>
                        <% if (currentPage < totalPages) { %>
                            <li class="page-item"><a class="page-link"
                                    href="?<%= queryParams.toString() %>&page=<%= currentPage + 1 %>">Next</a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Select Options Button - Navigate to product details
        const selectOptionsButtons = document.querySelectorAll('.btn-select-options');
        selectOptionsButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                if (!this.disabled) {
                    const productId = this.dataset.productId;
                    window.location.href = `/productDetails/${productId}`;
                }
            });
        });

        // Wishlist functionality
        const wishlistButtons = document.querySelectorAll('.btn-add-wishlist, .wishlist-icon');
        wishlistButtons.forEach(button => {
            button.addEventListener('click', async function (e) {
                e.preventDefault();
                e.stopPropagation();

                try {
                    const userId = document.body.dataset.userId;
                    const productId = this.getAttribute('data-product-id');

                    if (!userId) {
                        Swal.fire({
                            icon: 'error',
                            text: 'Please login to continue.',
                            showConfirmButton: true,
                            confirmButtonText: 'Login'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/user/login';
                            }
                        });
                        return;
                    }

                    const response = await fetch('/user/addToWishlist', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId, productId })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        Swal.fire({
                            icon: 'error',
                            text: data.error || 'Something went wrong',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        // Toggle heart icon for all wishlist buttons for this product
                        const productWishlistBtns = document.querySelectorAll(`[data-product-id="${productId}"]`);
                        productWishlistBtns.forEach(btn => {
                            const heartIcon = btn.querySelector('i');
                            if (heartIcon) {
                                if (heartIcon.classList.contains('far')) {
                                    heartIcon.classList.remove('far');
                                    heartIcon.classList.add('fas');
                                    btn.classList.add('active');
                                } else {
                                    heartIcon.classList.remove('fas');
                                    heartIcon.classList.add('far');
                                    btn.classList.remove('active');
                                }
                            }
                        });

                        Swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            text: data.message,
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                } catch (error) {
                    console.error('Add to wishlist error: ', error);
                }
            });
        });
         // User dropdown toggle and outside-click handling
    document.addEventListener('click', (e) => {
        const toggle = document.getElementById('userMenuToggle');
        const dropdown = document.getElementById('userDropdown');
        if (!toggle || !dropdown) return;

        if (toggle.contains(e.target)) {
            dropdown.classList.toggle('open');
            dropdown.setAttribute('aria-hidden', dropdown.classList.contains('open') ? 'false' : 'true');
        } else if (!dropdown.contains(e.target)) {
            dropdown.classList.remove('open');
            dropdown.setAttribute('aria-hidden', 'true');
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('open');
                dropdown.setAttribute('aria-hidden', 'true');
            }
        }
    });
    document.getElementById('clearFilters').addEventListener('click', function() {
    // Get the search result value if any
    const searchResult = document.querySelector('input[name="result"]').value;
    
    // Redirect to shop page with only search result (if exists)
    if (searchResult) {
        window.location.href = `/shop?result=${encodeURIComponent(searchResult)}`;
    } else {
        window.location.href = '/shop';
    }
});

    </script>
</body>

</html>