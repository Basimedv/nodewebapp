<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Edit Profile' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css">
    
    <style>
        body { background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .profile-container { min-height: 100vh; padding: 40px 0; }
        .col-md-9 { max-width: 900px; margin: 0 auto; }
        h1 { font-size: 24px; font-weight: 600; margin-bottom: 30px; }
        .edit-form { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
        
        /* Animated Green Border Line */
        .edit-form::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 4px; background: linear-gradient(90deg, transparent 0%, #198754 50%, transparent 100%); animation: moveBorder 3s linear infinite; }
        @keyframes moveBorder { 0% { left: -100%; } 100% { left: 100%; } }
        .edit-form.active::before { animation: moveBorder 2s linear infinite; }
        
        .profile-image-section { text-align: center; margin-bottom: 40px; padding-bottom: 30px; border-bottom: 1px solid #e5e5e5; }
        .profile-image-wrapper { position: relative; display: inline-block; margin-bottom: 15px; }
        .profile-edit-avatar { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #f0f0f0; }
        .profile-edit-placeholder { width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; border: 4px solid #f0f0f0; margin: 0 auto; }
        .camera-button { position: absolute; bottom: 5px; right: 5px; width: 45px; height: 45px; border-radius: 50%; background-color: #198754; border: 4px solid white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .camera-button:hover { background-color: #146c43; transform: scale(1.05); }
        
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
        
        .form-group label { font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px; display: block; }
        .form-control { padding: 12px 16px; border: 1px solid #ddd; border-radius: 6px; }
        .form-control:focus { border-color: #198754; box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.1); }
        
        .action-buttons { margin-top: 30px; padding-top: 25px; border-top: 1px solid #e5e5e5; display: flex; gap: 15px; }
        .btn-update { background-color: #198754; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-weight: 500; transition: 0.2s; }
        .btn-update:hover { background-color: #146c43; transform: translateY(-1px); }
        .btn-cancel { background-color: transparent; color: #6c757d; border: 1px solid #6c757d; padding: 12px 30px; border-radius: 6px; text-decoration: none; }
    </style>
</head>
<body>
    <%- include("../partials/user/header") %>
    
    <div class="profile-container">
        <div class="row">
            <div class="col-md-3">
                <%- include('../partials/user/profileSidebar', { activePage: 'profile', user: user }) %>
            </div>
            <div class="col-md-9">
                <h1>Update Profile</h1>

                <form id="profileForm" class="edit-form" enctype="multipart/form-data">
                    <div class="profile-image-section">
                        <div class="profile-image-wrapper">
                            <div id="profilePreview">
                                <% if (user.profileImage) { %>
                                    <img src="<%= user.profileImage %>" class="profile-edit-avatar">
                                <% } else { %>
                                    <div class="profile-edit-placeholder">
                                        <i class="fas fa-user" style="font-size: 60px; color: white;"></i>
                                    </div>
                                <% } %>
                            </div>
                            
                            <label for="profileImageInput" class="camera-button">
                                <i class="fas fa-camera" style="color: white; font-size: 18px;"></i>
                            </label>
                            <input type="file" id="profileImageInput" name="profileImage" accept="image/*" style="display: none;">
                        </div>
                        
                        <% if (user.profileImage) { %>
                            <div class="remove-photo-btn">
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="deleteImageBtn">
                                    <i class="fas fa-trash"></i> Remove Photo
                                </button>
                            </div>
                        <% } %>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" value="<%= user.fullName.split(' ')[0] %>" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" value="<%= user.fullName.split(' ').slice(1).join(' ') %>" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" value="<%= user.email %>" disabled>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone" value="<%= user.phone || '' %>">
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label>Username</label>
                        <input type="text" class="form-control" id="username" name="username" value="<%= (user.username && user.username !== 'Username not set yet') ? user.username : '' %>">
                    </div>

                    <div class="form-group mb-3">
                        <label>Gender</label>
                        <div class="pt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gender" id="male" value="Male" <%= user.gender === 'Male' ? 'checked' : '' %>>
                                <label class="form-check-label" for="male">Male</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gender" id="female" value="Female" <%= user.gender === 'Female' ? 'checked' : '' %>>
                                <label class="form-check-label" for="female">Female</label>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn-update">Update Profile</button>
                        <a href="/profile" class="btn-cancel">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Form animation
        const form = document.querySelector('.edit-form');
        form.querySelectorAll('input').forEach(i => {
            i.addEventListener('focus', () => form.classList.add('active'));
            i.addEventListener('blur', () => form.classList.remove('active'));
        });

        // 1. Image Preview with Toast
        document.getElementById('profileImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire('Too Large', 'File size must be less than 5MB', 'error');
                    this.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('profilePreview').innerHTML = `<img src="${event.target.result}" class="profile-edit-avatar">`;
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Image ready to upload!',
                        showConfirmButton: false,
                        timer: 2500
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // 2. Delete Photo with Confirmation
        document.getElementById('deleteImageBtn')?.addEventListener('click', function() {
            Swal.fire({
                title: 'Remove photo?',
                text: "Your profile picture will be deleted.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, remove it'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch('/profile/image', { method: 'DELETE' });
                        const data = await response.json();
                        if (data.success) {
                            Swal.fire('Removed!', 'Photo has been deleted.', 'success').then(() => location.reload());
                        }
                    } catch (err) {
                        Swal.fire('Error', 'Could not remove photo.', 'error');
                    }
                }
            });
        });

        // 3. Form Submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Basic Validation
            const phone = document.getElementById('phone').value;
            if(phone && !/^\d{10}$/.test(phone.trim())) {
                return Swal.fire('Invalid Phone', 'Please enter a valid 10-digit number', 'warning');
            }

            Swal.fire({
                title: 'Saving Changes',
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false
            });

            try {
                const response = await fetch('/profile/update', {
                    method: 'POST',
                    body: new FormData(this)
                });
                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Profile Updated',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => window.location.href = '/profile');
                } else {
                    Swal.fire('Update Failed', data.message || 'Error occurred', 'error');
                }
            } catch (err) {
                Swal.fire('Server Error', 'Please try again later', 'error');
            }
        });
    </script>
</body>
</html>